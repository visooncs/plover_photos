# Plover Photos - 系统规划与设计文档 (前后端分离版)

## 1. 项目愿景
Plover Photos 是一款基于 **Django 6** 和 **Vue 3** 开发的现代化、高性能的私有云相册管理系统。它旨在为用户提供类似 Google Photos 或 Apple Photos 的流畅体验，同时保持数据完全私有（Self-Hosted）。

核心设计理念是：采用**前后端分离**架构，后端利用 Django 的强大生态处理数据与 AI 任务，前端利用 Vue 3 构建响应迅速的单页应用 (SPA)。

## 2. 核心功能

### 2.1 照片管理
- **照片导入**: 支持本地文件夹扫描、Web 界面拖拽上传。
- **元数据解析**: 自动提取 EXIF 信息（拍摄时间、相机型号、光圈、ISO、GPS 坐标等）。
- **缩略图生成**: 利用后台任务异步生成多种尺寸的缩略图，支持 WebP 格式。
- **动态照片支持**: 
  - 支持 **Apple Live Photos** (HEIC + MOV)。
  - 支持 **Android Motion Photos** (JPEG 中嵌入视频)。
  - 前端支持长按/鼠标悬停播放动态效果。

### 2.2 浏览体验
- **瀑布流布局**: 基于 CSS Grid/Flexbox 的自适应网格展示。
- **时间轴视图**: 按年、月、日自动分组照片，支持快速滚动定位。
- **大图查看器**: 沉浸式查看体验，支持手势缩放、键盘导航。
- **地图模式**: 基于 GPS 信息在地图组件（Leaflet/Mapbox）上展示照片足迹。

### 2.3 组织与检索
- **智能相册**: 基于规则（如“2024年”、“风景”）自动归类。
- **手动相册**: 传统的文件夹式管理。
- **人物相册**: 基于 AI 人脸识别自动聚类。
- **强大的搜索**: 支持自然语言语义搜索（CLIP），以及按时间、地点、标签组合搜索。

## 3. 技术栈架构

### 3.1 后端 (Backend)
- **Framework**: **Django 6.0** (Python 3.12+)
- **API**: **Django REST Framework (DRF)**
  - 提供 RESTful API 供前端调用。
  - 使用 Serializers 处理数据序列化与验证。
- **AI Engine**: 
  - **InsightFace**: 高精度人脸识别与特征提取。
  - **CLIP**: 图像语义理解与向量化。
- **Database**: **PostgreSQL** (Primary)
  - 使用 **pgvector** 扩展存储高维向量（人脸特征、语义特征）。
- **Task Queue**: Django Native Tasks / Celery (可选)
- **Security**: CORS 配置，Token/Session 认证。

### 3.2 前端 (Frontend)
- **Framework**: **Vue 3** (Composition API)
- **Build Tool**: **Vite**
- **State Management**: **Pinia** (用于管理用户会话、照片流缓存、大图浏览状态等)。
- **Routing**: **Vue Router** (单页应用路由管理)。
- **Networking**: **Fetch API** (原生异步请求)。
- **Styling**: **CSS Variables** + Scoped CSS (原生 CSS 方案，易于维护)。
- **Maps**: **Leaflet** (开源地图组件)。

### 3.3 目录结构
```text
photos.plover.store/
├── backend/                # Django 后端项目
│   ├── core/               # 核心配置 (settings, urls, wsgi)
│   ├── apps/
│   │   ├── photos/         # 核心业务逻辑 (Models, API Views, Serializers)
│   │   │   ├── models.py       # Photo, Album, Person 模型定义
│   │   │   ├── api.py          # DRF ViewSets
│   │   │   └── serializers.py  # 数据序列化
│   │   └── users/          # 用户管理 (预留)
│   ├── manage.py
│   └── requirements.txt
├── frontend/               # Vue 3 前端项目
│   ├── src/
│   │   ├── api/            # API 请求封装
│   │   ├── components/     # Vue 组件 (PhotoGrid, Lightbox等)
│   │   ├── views/          # 页面视图 (HomeView, AlbumView等)
│   │   ├── stores/         # Pinia 状态管理 (photo.js)
│   │   ├── router/         # 路由配置
│   │   └── App.vue
│   ├── package.json
│   └── vite.config.js
└── docs/                   # 项目文档
```

## 4. 数据模型设计 (核心实体)

### Photo (照片)
- `id`: UUID
- `file_path`: 原始文件存储路径
- `hash_md5`: 文件哈希（用于去重）
- `width`, `height`: 尺寸
- `captured_at`: 拍摄时间
- `latitude`, `longitude`: GPS 坐标
- `embedding_data`: 语义向量 (VectorField)
- `is_live_photo`: 是否为动态照片
- `video_path`: 关联视频路径

### Album (相册)
- `id`: UUID
- `name`: 名称
- `cover`: 封面图 (ForeignKey to Photo)
- `photos`: ManyToManyField to Photo

### Person (人物)
- `id`: UUID
- `name`: 姓名
- `cluster_id`: 聚类 ID
- `cover_photo`: 封面照片

## 5. 开发路线图 (Roadmap)

### 第一阶段：基础架构重构 (已完成)
- [x] 分离前后端目录结构。
- [x] 初始化 Django 后端与 Vue 3 前端。
- [x] 配置 DRF 与 CORS，打通前后端 API。
- [x] 实现基础照片列表 API 与前端展示。

### 第二阶段：核心功能迁移 (已完成基础部分)
- [x] **前端**: 实现瀑布流布局组件 (PhotoGrid)。
- [x] **前端**: 实现大图查看器 (Lightbox)。
- [x] **后端**: 完善 Photo API (分页、过滤、排序)。
- [x] **后端**: 迁移相册 (Album) 与人物 (Person) API。
- [x] **前端**: 实现相册列表页与详情页。
- [x] **前端**: 实现人物列表页与详情页。

### 第三阶段：AI 功能对接 (已完成)
- [x] **后端**: 暴露语义搜索 API。
- [x] **前端**: 实现搜索栏与结果展示页。
- [x] **前端**: 实现人物相册管理界面（合并、命名）。
- [x] **前端**: 实现地图模式。

### 第四阶段：高级特性与优化 (已完成)
- [x] **动态照片**: 前端播放器支持 Live Photo。
- [x] **性能优化**: 图片懒加载、虚拟滚动、响应式图片。
- [x] **移动端适配**: 响应式布局优化。
