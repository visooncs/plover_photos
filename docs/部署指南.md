# Plover Photos 部署指南

本指南详细介绍了如何在您的服务器或本地环境中部署 Plover Photos。

## 1. 环境准备

### 硬件要求
- **CPU**: 推荐 4 核及以上 (AI 处理需要)
- **RAM**: 推荐 8GB 及以上 (尤其是运行 AI 模型时)
- **GPU (可选)**: NVIDIA 显卡 (支持 CUDA) 可显著加速人脸识别和语义分析。
- **存储**: SSD 推荐用于数据库和缩略图，机械硬盘可用于存储原始照片。

### 软件要求
- **Docker**: 24.0+
- **Docker Compose**: 2.20+
- **操作系统**: Windows 11 (WSL2), Linux (Ubuntu 22.04+), macOS

## 2. Docker 一键部署 (推荐)

Docker 是最简单且推荐的部署方式，它包含了所有必要的依赖服务（PostgreSQL, Redis, Nginx 等）。

### 步骤 1: 获取代码
如果您还没有代码，请克隆仓库：
```bash
git clone https://github.com/visooncs/plover_photos.git
cd plover_photos/docker
```

### 步骤 2: 启动服务

**Windows (PowerShell):**
```powershell
.\deploy.ps1
```

**Linux / macOS:**
```bash
docker-compose up -d --build
```

### 步骤 3: 验证部署
启动完成后，访问以下地址检查服务状态：
- **前端页面**: `http://localhost`
- **后端 API**: `http://localhost:8200/api/` (返回 404 或 API 根目录是正常的)
- **后台管理**: `http://localhost:8200/admin/`

## 3. 配置说明

### 环境变量 (.env)
主要配置在 `docker-compose.yml` 中的 `environment` 部分，或者使用 `.env` 文件。

- `POSTGRES_PASSWORD`: 数据库密码
- `SECRET_KEY`: Django 安全密钥 (生产环境请务必修改)
- `DOCKER_PATH_MAPPINGS`: 宿主机路径映射 (Windows 特有，用于将 D:\ 映射为 /mnt/d)

### 存储映射
默认情况下，`docker-compose.yml` 挂载了以下卷：
- `postgres_data`: 数据库持久化存储
- `media_volume`: 缩略图和上传的文件
- `D:\` -> `/mnt/d`: 默认将 D 盘挂载到容器内，以便扫描照片。您可以在 `docker-compose.yml` 中修改 `volumes` 部分来挂载其他路径。

## 4. 系统更新

当有新版本发布时，请按以下步骤更新：

1. **拉取最新代码**:
   ```bash
   git pull
   ```

2. **运行更新脚本**:
   ```bash
   cd docker
   .\update.ps1
   # 或者
   docker-compose up -d --build
   ```
   这会自动重新构建镜像并重启容器。

## 5. AI 模型本地化

为了加快启动速度，建议手动下载 AI 模型：

1. **InsightFace (人脸识别)**:
   - 下载 [buffalo_l.zip](https://github.com/deepinsight/insightface/releases/download/v0.7/buffalo_l.zip)
   - 解压到项目根目录: `./models/insightface/models/buffalo_l/`
   - 确保包含 `.onnx` 文件。

2. **CLIP (语义搜索)**:
   - 模型会自动缓存到 `./models/huggingface/`。
   - 可从 HuggingFace 镜像站下载 `clip-ViT-B-32` 相关文件放入该目录。
