# Plover Photos 接口文档

本文档描述了后端 API 的主要端点和使用方法。

## 基础说明
- **Base URL**: `/api` (部分文件服务在根路径下)
- **Authentication**: 目前支持 Session 认证（Admin后台登录）或无认证（开发模式）。
- **Response Format**: JSON

## 1. 核心资源

### 1.1 照片 (Photos)

#### 获取照片列表
`GET /api/photos/`

支持分页和多种过滤参数。

**参数**:
- `page`: 页码 (默认 1)
- `page_size`: 每页数量 (默认 50)
- `captured_at__year`: 按年份筛选 (e.g. `2024`)
- `location_name`: 按地点名称筛选
- `people`: 人物 ID (筛选包含特定人物的照片)
- `search`: 语义搜索关键词 (需先生成向量索引)

#### 获取单张照片详情
`GET /api/photos/{id}/`

### 1.2 相册 (Albums)

#### 获取相册列表
`GET /api/albums/`

#### 获取相册详情
`GET /api/albums/{id}/`

### 1.3 人物 (People)

#### 获取人物列表
`GET /api/people/`
返回聚类后的人物列表，通常包含封面图和照片数量。

#### 更新人物信息
`PATCH /api/people/{id}/`
用于修改人物姓名。
```json
{
  "name": "New Name"
}
```

#### 删除人物
`DELETE /api/people/{id}/`
删除该人物实体，并释放其关联的所有人脸（变为未标记状态）。

#### 重置人物 (删除并重新归类)
`POST /api/people/{id}/reset/`
删除该人物实体，并释放其关联的所有人脸（变为未标记状态）。这些照片随后可以被重新聚类分析。
**用途**: 当人物被错误合并时，可以使用此功能将其打散，重新进行自动聚类。

#### 隐藏人物
`POST /api/people/{id}/hide/`
将人物设为隐藏状态，不再出现在默认列表中。

#### 取消隐藏人物
`POST /api/people/{id}/unhide/`
取消人物的隐藏状态。

### 1.4 媒体库 (Libraries)

#### 获取媒体库列表
`GET /api/libraries/`

#### 触发扫描
`POST /api/libraries/{id}/scan/`
**参数**:
- `force`: 是否强制重新扫描 (默认 `false`)

#### 暂停扫描
`POST /api/libraries/{id}/pause/`

## 2. 文件服务 (File Serving)

> **注意**: 为了性能和缓存控制，文件服务路径通常不带 `/api` 前缀。

### 获取照片文件 (缩略图/原图)
`GET /photo/{id}/serve/`

**参数**:
- `size`: 缩略图大小 (e.g. `300`, `800`)。不传则返回原图。
- `crop`: 是否裁剪为正方形 (`1` or `0`)。

### 获取视频文件
`GET /photo/{id}/video/`
支持 Range 请求，用于流式播放。

### 获取人脸裁剪图
`GET /face/{id}/crop/`

**参数**:
- `size`: 图片大小 (默认 `200`)。

## 3. 系统维护 (Maintenance)

### 3.1 维护任务 (Maintenance Tasks)

#### 获取任务列表
`GET /api/maintenance/`
返回最近执行的任务及其状态。

**支持的任务类型**:
- `scan_photos`: 扫描照片
- `process_faces`: 人脸识别
- `cluster_people`: 人脸聚类
- `generate_memories`: 生成回忆
- `cleanup_trash`: 清空回收站
- `update_gps`: 更新GPS信息
- `process_embeddings`: 生成语义向量

#### 运行/重试任务
`POST /api/maintenance/{id}/run/`
用于重新触发已存在的任务记录，或者通过特定参数运行。

### 3.2 定时任务 (Scheduled Tasks)

#### 获取定时任务列表
`GET /api/schedules/`
查看系统预设的定时任务（如每日扫描等）。

### 3.3 系统信息 (System)

#### 获取存储空间信息
`GET /api/system/storage/`
返回磁盘总空间、已用空间和照片库占用空间。

#### 手动触发人脸聚类
`POST /api/system/run_clustering/`
在后台触发人脸聚类分析。
**注意**: 此操作会自动合并发现的所有相似人物（阈值默认为 0.2）。

## 4. 地理信息 (Geo)

### 获取地点列表
`GET /api/photos/places/`
返回按地点名称聚合的列表，包含封面图。

### 获取地图标记点
`GET /map/markers/`
获取指定范围内的照片聚合点（用于地图展示）。

**参数**:
- `min_lat`, `max_lat`: 纬度范围
- `min_lng`, `max_lng`: 经度范围
- `zoom`: 缩放级别 (用于聚合计算)

## 5. 回忆 (Memories)

### 获取回忆列表
`GET /api/memories/`
获取生成的智能回忆卡片。
